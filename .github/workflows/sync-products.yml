name: Sync Squarespace Products

on:
  schedule:
    # Normal hourly sync (visible products only)
    - cron: '0 * * * *'
    # DROP DAY: Fetch ALL products at 12:45 PM PST (20:45 UTC)
    # Note: PST = UTC-8, but during PDT (Mar-Nov) = UTC-7
    # 12:45 PM PST = 20:45 UTC | 12:45 PM PDT = 19:45 UTC
    # We schedule both to cover PST and PDT
    - cron: '45 20 1 * *'
    - cron: '45 19 1 * *'
    # DROP DAY: Revert to visible-only at 2:00 PM PST/PDT
    # 2:00 PM PST = 22:00 UTC | 2:00 PM PDT = 21:00 UTC
    - cron: '0 22 1 * *'
    - cron: '0 21 1 * *'
  workflow_dispatch:
    inputs:
      include_hidden:
        description: 'Include hidden products (for drop day)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  sync-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine if this is a drop-day sync
        id: check-drop
        run: |
          # Check if manually triggered with include_hidden
          if [ "${{ github.event.inputs.include_hidden }}" = "true" ]; then
            echo "include_all=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ DROP DAY MODE: Manual trigger - including ALL products"
            exit 0
          fi

          # Get current time in PST/PDT
          CURRENT_HOUR=$(TZ='America/Los_Angeles' date +%H)
          CURRENT_MIN=$(TZ='America/Los_Angeles' date +%M)
          CURRENT_DAY=$(TZ='America/Los_Angeles' date +%d)
          TIME_IN_MIN=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MIN))

          echo "Current LA time: Day=$CURRENT_DAY Hour=$CURRENT_HOUR Min=$CURRENT_MIN ($TIME_IN_MIN min)"

          # 1st of the month, between 12:40 PM (760) and 1:59 PM (839)
          if [ "$CURRENT_DAY" = "01" ] && [ "$TIME_IN_MIN" -ge 760 ] && [ "$TIME_IN_MIN" -lt 840 ]; then
            echo "include_all=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ DROP DAY MODE: Including ALL products (hidden + visible)"
          else
            echo "include_all=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Normal sync: Visible products only"
          fi

      - name: Fetch Squarespace Products
        env:
          SQUARESPACE_API_KEY: ${{ secrets.SQUARESPACE_API_KEY }}
          INCLUDE_ALL: ${{ steps.check-drop.outputs.include_all }}
        run: |
          # Initialize empty products array
          echo '{"products": []}' > all-products.json

          cursor=""
          page=1

          # Loop through all pages
          while true; do
            echo "ðŸ“„ Fetching page $page..."

            # Build URL with cursor if we have one
            if [ -z "$cursor" ]; then
              url="https://api.squarespace.com/1.0/commerce/products"
            else
              url="https://api.squarespace.com/1.0/commerce/products?cursor=$cursor"
            fi

            # Fetch this page
            curl -X GET "$url" \
              -H "Authorization: Bearer $SQUARESPACE_API_KEY" \
              -H "User-Agent: WildOaks-Product-Sync" \
              -o "page-$page.json"

            # Check if successful
            if [ ! -s "page-$page.json" ]; then
              echo "âŒ Failed to fetch page $page"
              exit 1
            fi

            # Count products on this page
            page_count=$(jq '.products | length' "page-$page.json")
            echo "   Found $page_count products on page $page"

            # Merge products from this page into all-products
            jq -s '.[0].products + .[1].products | {products: .}' all-products.json "page-$page.json" > temp.json
            mv temp.json all-products.json

            # Check if there's a next page
            has_next=$(jq -r '.pagination.hasNextPage // false' "page-$page.json")

            if [ "$has_next" = "true" ]; then
              cursor=$(jq -r '.pagination.nextPageCursor' "page-$page.json")
              page=$((page + 1))
            else
              echo "âœ… No more pages. Total pages fetched: $page"
              break
            fi

            # Safety limit (prevent infinite loop)
            if [ $page -gt 20 ]; then
              echo "âš ï¸ Reached safety limit of 20 pages"
              break
            fi
          done

          # Count total products
          total=$(jq '.products | length' all-products.json)
          echo "ðŸ“Š Total products fetched: $total"

          # Transform to search-friendly format
          # DROP DAY: include ALL products | NORMAL: visible only
          if [ "$INCLUDE_ALL" = "true" ]; then
            echo "ðŸš€ DROP DAY: Including ALL products (visible + hidden)"
            cat all-products.json | jq '[.products[] | {
              name: .name,
              url: ("/shop/" + (.urlSlug // (.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))),
              category: (.categories[0] // ""),
              price: (.variants[0].pricing.basePrice.value // "0"),
              currency: (.variants[0].pricing.basePrice.currency // "USD"),
              image: (.images[0].url // ""),
              description: (.description // "")
            }] | sort_by(.name)' > products.json
          else
            echo "ðŸ“¦ Normal sync: Visible products only"
            cat all-products.json | jq '[.products[] | select(.isVisible == true) | {
              name: .name,
              url: ("/shop/" + (.urlSlug // (.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))),
              category: (.categories[0] // ""),
              price: (.variants[0].pricing.basePrice.value // "0"),
              currency: (.variants[0].pricing.basePrice.currency // "USD"),
              image: (.images[0].url // ""),
              description: (.description // "")
            }] | sort_by(.name)' > products.json
          fi

          # Clean up
          rm all-products.json page-*.json

          final_count=$(jq length products.json)
          echo "âœ… Successfully processed $final_count products"

      - name: Commit and Push Updated Products
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add products.json

          if git diff --staged --quiet; then
            echo "No changes to products.json"
          else
            INCLUDE_ALL="${{ steps.check-drop.outputs.include_all }}"
            if [ "$INCLUDE_ALL" = "true" ]; then
              git commit -m "ðŸš€ DROP DAY: All products sync - $(date -u +'%Y-%m-%d %H:%M UTC')"
            else
              git commit -m "ðŸ”„ Auto-update products - $(date -u +'%Y-%m-%d %H:%M UTC')"
            fi
            git push
            echo "âœ… Products updated and pushed"
          fi
