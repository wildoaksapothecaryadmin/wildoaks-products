name: Sync Squarespace Products

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Squarespace Products
        env:
          SQUARESPACE_API_KEY: ${{ secrets.SQUARESPACE_API_KEY }}
        run: |
          # Initialize empty products array
          echo '{"products": []}' > all-products.json

          cursor=""
          page=1

          # Loop through all pages
          while true; do
            echo "ðŸ“„ Fetching page $page..."

            # Build URL with cursor if we have one
            if [ -z "$cursor" ]; then
              url="https://api.squarespace.com/1.0/commerce/products"
            else
              url="https://api.squarespace.com/1.0/commerce/products?cursor=$cursor"
            fi

            # Fetch this page
            curl -X GET "$url" \
              -H "Authorization: Bearer $SQUARESPACE_API_KEY" \
              -H "User-Agent: WildOaks-Product-Sync" \
              -o "page-$page.json"

            # Check if successful
            if [ ! -s "page-$page.json" ]; then
              echo "âŒ Failed to fetch page $page"
              exit 1
            fi

            # Count products on this page
            page_count=$(jq '.products | length' "page-$page.json")
            echo "   Found $page_count products on page $page"

            # Merge products from this page into all-products
            jq -s '.[0].products + .[1].products | {products: .}' all-products.json "page-$page.json" > temp.json
            mv temp.json all-products.json

            # Check if there's a next page
            has_next=$(jq -r '.pagination.hasNextPage // false' "page-$page.json")

            if [ "$has_next" = "true" ]; then
              cursor=$(jq -r '.pagination.nextPageCursor' "page-$page.json")
              page=$((page + 1))
            else
              echo "âœ… No more pages. Total pages fetched: $page"
              break
            fi

            # Safety limit (prevent infinite loop)
            if [ $page -gt 20 ]; then
              echo "âš ï¸ Reached safety limit of 20 pages"
              break
            fi
          done

          # Count total products
          total=$(jq '.products | length' all-products.json)
          echo "ðŸ“Š Total products fetched: $total"

          # Transform to search-friendly format (only visible products)
          cat all-products.json | jq '[.products[] | select(.isVisible == true) | {
            name: .name,
            url: ("/shop/" + (.urlSlug // (.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))),
            category: (.categories[0] // ""),
            price: (.variants[0].pricing.basePrice.value // "0"),
  currency: (.variants[0].pricing.basePrice.currency // "USD"),
            image: (.images[0].url // ""),
            description: (.description // "")
          }] | sort_by(.name)' > products.json

          # Clean up
          rm all-products.json page-*.json

          final_count=$(jq length products.json)
          echo "âœ… Successfully processed $final_count products"

      - name: Commit and Push Updated Products
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add products.json

          if git diff --staged --quiet; then
            echo "No changes to products.json"
          else
            git commit -m "ðŸ”„ Auto-update products - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Products updated and pushed"
          fi
