name: Sync Squarespace Products

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Squarespace Products
        env:
          SQUARESPACE_API_KEY: ${{ secrets.SQUARESPACE_API_KEY }}
        run: |
          curl -X GET "https://api.squarespace.com/1.0/commerce/products" \
            -H "Authorization: Bearer $SQUARESPACE_API_KEY" \
            -H "User-Agent: WildOaks-Product-Sync" \
            -o raw-products.json

          if [ ! -s raw-products.json ]; then
            echo "Error: Failed to fetch products from Squarespace API"
            exit 1
          fi

          cat raw-products.json | jq '[.products[] | {
            name: .name,
            isVisible: .isVisible,
            status: .status,
            isPublished: .isPublished,
            url: ("/shop/" + (.urlSlug // (.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))),
            category: (.categories[0] // "Products"),
            price: (.variants[0].priceMoney.value // "0"),
            currency: (.variants[0].priceMoney.currency // "USD"),
            image: (.images[0].url // ""),
            description: (.description // "")
          }] | sort_by(.name)' > products.json

          rm raw-products.json
          echo "âœ… Successfully processed $(jq length products.json) products"

      - name: Commit and Push Updated Products
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add products.json

          if git diff --staged --quiet; then
            echo "No changes to products.json"
          else
            git commit -m "ðŸ”„ Auto-update products - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Products updated and pushed"
          fi
